<?xml version="1.0" encoding="UTF-8"?>
<!--
Azure API Management Policy for GitHub GraphQL API
This policy handles authentication and common error scenarios
-->
<policies>
  <inbound>
    <base />

    <authentication-managed-identity 
            resource="https://analysis.windows.net/powerbi/api" 
            client-id="{{managed_identity_client_id}}" 
            output-token-variable-name="token-variable" 
            ignore-error="false" />
    
    <set-header name="Authorization" exists-action="override">
            <value>@("Bearer " + (string)context.Variables["token-variable"])</value>
    </set-header>
    
    <set-header name="User-Agent" exists-action="override">
      <value>Azure-API-Management/1.0</value>
    </set-header>
    
    <!-- Set Content-Type for GraphQL -->
    <set-header name="Content-Type" exists-action="override">
      <value>application/json</value>
    </set-header>
  </inbound>
  
  <backend>
    <base />
  </backend>
  
  <outbound>
    <base />
  </outbound>
  
  <on-error>
    <base />
  </on-error>
  
</policies>